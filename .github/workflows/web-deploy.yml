name: Build & Deploy Websites
permissions:
  contents: read

on:
  push:
    branches:
      - main

jobs:
  detect-sites:
    runs-on: ubuntu-latest
    outputs:
      sites: ${{ steps.changed.outputs.sites }}
    steps:
      - uses: actions/checkout@v4

      - id: changed
        run: |
          # Detect changed site directories
          RAW=$(git diff --name-only HEAD^ HEAD | grep '^web/sites/' || true)

          if [ -z "$RAW" ]; then
            echo "No site changes detected"
            echo "sites=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract folder names (site domains), make unique, convert to JSON array
          SITES=$(echo "$RAW" \
            | cut -d'/' -f3 \
            | sort -u \
            | jq -R -s -c 'split("\n")[:-1]')

          echo "Detected sites: $SITES"
          echo "sites=$SITES" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-sites
    if: ${{ needs.detect-sites.outputs.sites != '[]' }}
    strategy:
      matrix:
        site: ${{ fromJson(needs.detect-sites.outputs.sites) }}

    name: "Deploy: ${{ matrix.site }}"
    uses: ./.github/workflows/site-template.yml
    with:
      site: ${{ matrix.site }}
    secrets:
      server_host: ${{ secrets.VPS_HOST }}
      server_ssh_port: ${{ secrets.VPS_PORT }}
      server_key: ${{ secrets.VPS_CI_KEY }}
      server_key_password: ${{ secrets.VPS_CI_KEY_PASSWORD }}