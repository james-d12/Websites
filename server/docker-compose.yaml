name: websites

services:
  nix:
    image: nixos/nix
    container_name: nix
    restart: unless-stopped
    tty: true
    stdin_open: true
    working_dir: /flake
    volumes:
      - ./config:/flake:rw,Z
    environment:
      NIX_CONFIG: "experimental-features = nix-command flakes"

  nixos-fts:
    image: nixos/nix
    container_name: nixos-fts
    working_dir: /flake
    tty: true
    stdin_open: true
    volumes:
      - ./config:/flake:rw,Z
    environment:
      NIX_CONFIG: "experimental-features = nix-command flakes"
    env_file: ".env"
    command: nix run github:nix-community/nixos-anywhere -- --flake .#vps --generate-hardware-config nixos-generate-config ./modules/hardware.nix root@$TARGET_HOST

  nixos-rebuild:
    image: nixos/nix
    container_name: nixos-rebuild
    working_dir: /flake
    tty: true
    stdin_open: true
    volumes:
      - ./config:/flake:rw,Z
    environment:
      NIX_CONFIG: "experimental-features = nix-command flakes"
    env_file: ".env"
    command: nixos-rebuild switch --flake ./config --target-host "$USER@$TARGET_HOST"
